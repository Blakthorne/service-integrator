name: Build and Deploy Next.js to Digital Ocean

on:
    push:
        branches:
            - main

jobs:
    build-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Install dependencies
              run: npm ci

            - name: Build app
              run: npm run build

            - name: Create deployment package
              run: |
                  mkdir -p deploy
                  cp -r .next deploy/
                  cp -r public deploy/ 2>/dev/null || :
                  cp package.json deploy/
                  cp package-lock.json deploy/
                  cp next.config.ts deploy/

                  # Install production dependencies only
                  cd deploy
                  npm ci --production --ignore-scripts
                  cd ..

                  # Create tarball
                  tar -czf deploy.tar.gz -C deploy .

            - name: Transfer deployment package
              uses: appleboy/scp-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  source: "deploy.tar.gz"
                  target: "/tmp/"

            - name: Extract and restart on server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      cd ~/service-integrator
                      tar -xzf /tmp/deploy.tar.gz
                      rm /tmp/deploy.tar.gz
                      pm2 restart service-integrator
