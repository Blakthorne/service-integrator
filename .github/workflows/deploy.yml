# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: Build and Deploy Next.js to Digital Ocean

on:
    push:
        branches:
            - main

jobs:
    build-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Install dependencies
              run: npm ci

            - name: Create .env.production file
              run: |
                  cat > .env.production << 'EOF'
                  AUTH_SECRET=${{ secrets.AUTH_SECRET }}
                  AUTH_GOOGLE_ID=${{ secrets.AUTH_GOOGLE_ID }}
                  AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}
                  ALLOWED_EMAIL_1=${{ secrets.ALLOWED_EMAIL_1 }}
                  ALLOWED_EMAIL_2=${{ secrets.ALLOWED_EMAIL_2 }}
                  PLANNING_CENTER_ID=${{ secrets.PLANNING_CENTER_ID }}
                  PLANNING_CENTER_TOKEN=${{ secrets.PLANNING_CENTER_TOKEN }}
                  NEXT_PUBLIC_BASE_URL=${{ secrets.NEXT_PUBLIC_BASE_URL }}
                  EOF

            - name: Build app
              run: npm run build

            - name: Create deployment package
              run: |
                  mkdir -p deploy
                  cp -r .next deploy/
                  cp -r public deploy/ 2>/dev/null || :
                  cp package.json deploy/
                  cp package-lock.json deploy/
                  cp next.config.ts deploy/
                  cp .env.production deploy/

                  # Install production dependencies only
                  cd deploy
                  npm ci --production --ignore-scripts
                  cd ..

                  # Create tarball
                  tar -czf deploy.tar.gz -C deploy .

            - name: Transfer deployment package
              uses: appleboy/scp-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  source: "deploy.tar.gz"
                  target: "/tmp/"

            - name: Extract and restart on server
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.HOST }}
                  username: ${{ secrets.USERNAME }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      cd ~/service-integrator
                      tar -xzf /tmp/deploy.tar.gz
                      rm /tmp/deploy.tar.gz
                      pm2 restart service-integrator
